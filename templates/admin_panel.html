{# templates/admin_panel.html #}
{% extends "base.html" %}
{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="card">
  <h2 class="panel-title">ADMIN PANEL</h2>

  <p style="font-weight:600;">Logged in as: {{ session.get('admin_phone') or 'â€”' }}</p>

  <div style="margin-top:12px; display:flex; flex-direction:column; gap:12px;">
    <!-- Generate form (posts to admin_panel) -->
    <form method="post" action="{{ url_for('admin_panel') }}" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;">
      <div style="flex:1; min-width:220px;">
        <label style="display:block; margin-bottom:6px; font-weight:700;">Start date:</label>
        <input type="date" name="start_date" required class="date-select">
      </div>

      <div style="flex:1; min-width:220px;">
        <label style="display:block; margin-bottom:6px; font-weight:700;">End date:</label>
        <input type="date" name="end_date" required class="date-select">
      </div>

      <div style="display:flex; gap:8px; margin-top:6px;">
        <button class="btn" type="submit">Generate Slots</button>
      </div>
    </form>

    <!-- Delete Slots (range) - posts to admin_clear_slots -->
    <form method="post" action="{{ url_for('admin_clear_slots') }}"
          onsubmit="return confirm('Delete all slots and bookings in the selected date range? This cannot be undone.');"
          style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <!-- hidden fields will be populated by JS from the visible date inputs above -->
      <input type="hidden" name="start_date" id="clear_start">
      <input type="hidden" name="end_date" id="clear_end">
      <button class="btn btn-danger" type="submit">Delete Slots</button>

      <div style="margin-left:8px; color:#315a72; font-size:14px;">
        <small>Deletes IssueDate, Slot rows and Bookings in the chosen range.</small>
      </div>
    </form>
  </div>

  <hr style="margin:18px 0; border:none; height:1px; background:#eef6fb;">

  <div style="margin-top:8px;">
    <p style="margin:6px 0;"><strong>Existing slots in DB:</strong> {{ existing_count if existing_count is defined else 0 }}</p>

    <p style="margin:8px 0 6px;"><strong>Current active issue dates:</strong></p>

    <div class="active-dates" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;">
      {% if active_dates %}
        {% for d in active_dates %}
          <div class="date-pill" style="background:#f7fbff; padding:8px 12px; border-radius:10px; display:flex; align-items:center; gap:8px; box-shadow: 0 6px 12px rgba(20,40,60,0.04);">
            <span style="font-weight:700; color:#184a63;">{{ d }}</span>

            <!-- Delete single-date form -->
            <form method="post" action="{{ url_for('admin_delete_date', date_iso=d) }}"
                  style="display:inline-block; margin:0;" onsubmit="return confirm('Delete date {{ d }} and all its slots/bookings?');">
              <button type="submit" class="btn btn-danger-small">Delete</button>
            </form>
          </div>
        {% endfor %}
      {% else %}
        <div style="color:#456c86; padding:8px 12px; background:#fff; border-radius:8px;">No active issue dates configured.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Sync script: copy the visible date inputs into the hidden delete form fields -->
<script>
  (function(){
    function syncDateInputs(){
      const start = document.querySelector('input[name="start_date"]');
      const end = document.querySelector('input[name="end_date"]');
      const hStart = document.getElementById('clear_start');
      const hEnd = document.getElementById('clear_end');
      if (!start || !end || !hStart || !hEnd) return;
      hStart.value = start.value;
      hEnd.value = end.value;
    }
    window.addEventListener('load', syncDateInputs);
    document.addEventListener('input', function(e){
      if (e.target && (e.target.name === 'start_date' || e.target.name === 'end_date')) {
        syncDateInputs();
      }
    });
  })();
</script>

{% endblock %}
