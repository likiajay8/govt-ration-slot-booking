{% extends "base.html" %}
{% block title %}User Panel{% endblock %}

{% block content %}
<div class="card large-card">
  <h2 class="panel-title">USER PANEL</h2>

  <p class="welcome"><strong>Welcome, {{ user.name }}</strong><br>
  Ration Card: {{ user.ration_card }}<br>
  Phone: {{ user.phone }}</p>

  <h3 class="section-title">Available Issue Dates</h3>

  <form method="get" action="{{ url_for('user_panel') }}" class="date-form">
    <select name="date" class="date-select" required>
      {% for d in allowed_dates %}
        <option value="{{ d }}" {% if selected_date and selected_date.isoformat()==d %}selected{% endif %}>{{ d }}</option>
      {% endfor %}
    </select>

    <!-- signal to server to show slots -->
    <input type="hidden" name="show" value="1">
    <button class="btn" type="submit">View Slots</button>
  </form>

  {% if show_slots %}
    {% if selected_date %}
      <p class="date-heading">Date: {{ selected_date.strftime('%d/%m/%Y') }}</p>
    {% endif %}

    {% if user_booking %}
      <div class="info-row notice">
        You have already booked a slot in the current active dates.
        Booking time: {{ user_booking.slot.start_time.strftime('%H:%M') }} â€” Reference: <strong>{{ user_booking.ref_code }}</strong>
      </div>
    {% endif %}

    <div class="slots-grid">
      {% for s in slots %}
        <div class="slot-card {% if s.booked %}slot-booked{% endif %}">
          <div class="slot-time">{{ s.start_time.strftime('%H:%M') }}</div>

          {% if s.booked %}
            {% set booking = s.bookings|first %}
            {% if booking and booking.user_id == session.get('user_id') %}
              <button class="btn btn-disabled your-booking">Your booking</button>
            {% else %}
              <button class="btn btn-disabled">Booked</button>
            {% endif %}
          {% else %}
            {% if user_booking %}
              <button class="btn btn-disabled">Unavailable</button>
            {% else %}
              <form method="post" action="{{ url_for('book', slot_id=s.id) }}">
                <button class="btn btn-primary" type="submit">Book</button>
              </form>
            {% endif %}
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}
